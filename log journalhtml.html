<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* --- Global Theme (Identical to Rules Codex) --- */
        :root {
            --bg-main: #212121;
            --bg-section: #333333;
            --bg-header: #1f2937;
            --bg-input: #424242;
            --bg-input-focus: #616161;
            --bg-hover: #4f4f4f;
            --bg-danger: #b71c1c;
            --bg-danger-hover: #d32f2f;
            
            --text-light: #f5f5f5;
            --text-dark: #212121;
            --text-subtle: #9e9e9e;
            
            --border-main: #9e9e9e;
            --border-subtle: #616161;
            --border-focus: #f5f5f5;

            --btn-primary-bg: #4f4f4f;
            --btn-primary-border: #9e9e9e;
            --btn-primary-hover-bg: #616161;
            --btn-primary-hover-border: #f5f5f5;

            --btn-danger-bg: #b71c1c;
            --btn-danger-border: #9e9e9e;
            --btn-danger-hover-bg: #d32f2f;
            --btn-danger-hover-border: #f5f5f5;
            
            --font-body: 'Trebuchet MS', sans-serif;
            --font-display: 'Trebuchet MS', sans-serif;

            --header-height: 4rem; 
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--bg-section); }
        ::-webkit-scrollbar-thumb {
            background-color: var(--bg-input-focus);
            border-radius: 6px;
            border: 3px solid var(--bg-section);
        }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--border-main); }

        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-main);
            color: var(--text-light);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Layout --- */
         .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 40;
            background-color: var(--bg-header);
            border-bottom: 2px solid var(--border-subtle);
            padding: 0.5rem 1rem;
        }
        .app-container {
            display: flex;
            flex-grow: 1;
            padding-top: var(--header-height);
        }
        main#main-content {
            flex-grow: 1;
            padding: 0;
            overflow-y: auto;
        }

        /* --- Global Components --- */
        .app-header h1 { font-family: var(--font-display); }
        .modal-backdrop { background-color: rgba(0,0,0,0.75); }
        .modal-content {
            background-color: var(--bg-section);
            border: 2px solid var(--border-main);
        }
        .modal-content h2 {
            font-family: var(--font-display);
            text-transform: uppercase;
        }
        .global-form-label {
            color: var(--text-subtle);
            text-transform: uppercase;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        .global-form-input {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-light);
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }
        .global-form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            background-color: var(--bg-input-focus);
        }
        .global-form-input.display-only-input {
            background-color: var(--bg-header);
            cursor: default;
            border-color: var(--border-subtle);
        }
        .global-form-input.display-only-input:focus {
            background-color: var(--bg-header);
            border-color: var(--border-subtle);
        }
        .entry-link {
            color: #63b3ed;
            text-decoration: underline;
            cursor: pointer;
        }
        .entry-link:hover { color: #90cdf4; }

        /* --- Content-Specific Styles --- */
        .entry-content h2 {
            font-family: var(--font-display);
            font-size: 2.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-light);
            text-transform: uppercase;
            text-align: center;
            border-bottom: 2px solid var(--border-subtle);
            padding-bottom: 0.75rem;
        }
        .entry-content h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--text-light);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 0.5rem;
        }
        .entry-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: var(--text-light);
        }

        .btn {
            font-family: var(--font-body);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-shadow: 1px 1px 2px #000;
            text-transform: uppercase;
        }
        .btn:hover { text-shadow: none; }
        
        .btn-primary { background-color: var(--btn-primary-bg); border-color: var(--btn-primary-border); color: var(--text-light); }
        .btn-primary:hover { background-color: var(--btn-primary-hover-bg); border-color: var(--btn-primary-hover-border); }
        .btn-danger { background-color: var(--bg-danger); border-color: var(--btn-danger-border); color: var(--text-light); }
        .btn-danger:hover { background-color: var(--bg-danger-hover); border-color: var(--btn-danger-hover-border); }
        .btn-secondary { background-color: var(--bg-section); border-color: var(--text-subtle); color: var(--text-light); }
        .btn-secondary:hover { background-color: var(--bg-hover); border-color: var(--border-focus); }

        /* Quill Dark Theme Overrides */
        .ql-toolbar {
            background-color: var(--bg-header);
            border: 1px solid var(--border-main) !important;
            border-bottom: none !important;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }
        .ql-container.ql-snow {
            border: 1px solid var(--border-main) !important;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            background-color: var(--bg-input);
            color: var(--text-light);
            font-family: var(--font-body);
        }
        .ql-editor { min-height: 200px; }
        .ql-editor.ql-blank::before { color: var(--text-subtle); font-style: normal; }
        .ql-snow .ql-stroke { stroke: var(--text-subtle); }
        .ql-snow .ql-fill, .ql-snow .ql-stroke.ql-fill { fill: var(--text-subtle); }
        .ql-snow.ql-toolbar button:hover .ql-stroke, .ql-snow .ql-toolbar button:hover .ql-stroke,
        .ql-snow.ql-toolbar button.ql-active .ql-stroke, .ql-snow .ql-toolbar button.ql-active .ql-stroke { stroke: var(--text-light); }
        .ql-snow.ql-toolbar button:hover .ql-fill, .ql-snow .ql-toolbar button:hover .ql-fill,
        .ql-snow.ql-toolbar button.ql-active .ql-fill, .ql-snow .ql-toolbar button.ql-active .ql-fill { fill: var(--text-light); }
        .ql-snow .ql-picker-options { background-color: var(--bg-section); border-color: var(--border-main) !important; }
        .ql-snow .ql-picker-item:hover, .ql-snow .ql-picker-label:hover { color: var(--text-light); }
        .ql-snow .ql-picker-item.ql-selected { color: var(--text-light); }
        .ql-snow .ql-tooltip { background-color: var(--bg-section); border: 1px solid var(--border-main); box-shadow: none; color: var(--text-light); }
        .ql-snow .ql-tooltip input[type=text] { background-color: var(--bg-input); border: 1px solid var(--border-main); color: var(--text-light); }
        .ql-snow .ql-tooltip a.ql-action::after { border-radius: 0.25rem; background-color: var(--btn-primary-bg); color: var(--text-light); padding: 4px 8px; }
        
        /* Prose styles for rendered Quill content */
        .prose { color: var(--text-light); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--text-light); }
        .prose a { color: #63b3ed; }
        .prose a:hover { color: #90cdf4; }
        .prose blockquote { color: var(--text-subtle); border-left-color: var(--border-main); }
        .prose code { background-color: var(--bg-header); color: #a5f3fc; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-weight: bold; }
        .prose .ql-syntax { background-color: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 5px; white-space: pre-wrap; }

    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header flex justify-center items-center">
        <div class="text-center">
            <h1 class="text-xl font-bold text-gray-100 whitespace-nowrap">LOG JOURNAL</h1>
            <p class="text-xs text-gray-400 uppercase">A Personal Digital Log</p>
        </div>
    </header>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Main Content Area -->
        <main id="main-content"></main>
    </div>

    <!-- Main Entry Modal -->
    <div id="entry-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-3/4 max-w-6xl max-h-[90vh] overflow-y-auto flex flex-col relative">
             <button id="modal-explicit-close-btn" class="absolute top-2 right-2 btn btn-secondary !p-2 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                   <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
            <div class="p-8">
                <h2 id="modal-title" class="text-2xl font-bold text-center mb-6">Manage Entry</h2>
                <form id="entry-form">
                    <div id="form-fields" class="space-y-6">
                        <!-- Form fields are dynamically generated here -->
                    </div>
                    <div class="flex justify-end gap-4 mt-8">
                        <button type="button" id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="modal-delete-btn" class="btn btn-danger hidden">Delete</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-8">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="btn btn-secondary">CANCEL</button>
                <button id="confirm-ok-btn" class="btn btn-danger">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-8">
            <h2 class="text-xl font-bold mb-4 text-red-500">Error</h2>
            <p id="error-message" class="text-gray-400 mb-6">Something went wrong.</p>
            <div class="flex justify-end">
                <button id="error-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Application Configuration ---
        const entryConfig = {
            label: 'Journal Entry',
            fields: {
                title: { type: 'text', required: true },
                tags: { type: 'text', label: 'Tags (comma-separated)' },
                content: { type: 'textarea' },
            }
        };

        // --- Application State ---
        const appState = {
            editingEntryId: null,
            confirmCallback: null,
            journalEntries: [],
            currentEntryId: null,
        };
        
        // --- UI Element References ---
        const mainContentContainer = document.getElementById('main-content');
        const entryModal = document.getElementById('entry-modal');
        const modalTitle = document.getElementById('modal-title');
        const entryForm = document.getElementById('entry-form');
        const formFieldsContainer = document.getElementById('form-fields');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const errorOkBtn = document.getElementById('error-ok-btn');

        // --- View Rendering ---
        function renderJournalView() {
            mainContentContainer.innerHTML = `
                <div class="flex" style="height: calc(100vh - var(--header-height));">
                    <div id="journal-directory-main" class="w-80 flex-shrink-0 bg-gray-800 p-4 overflow-y-auto border-r-2 border-gray-700">
                        <div class="mb-4">
                            <input type="search" id="search-input" placeholder="Search entries..." class="global-form-input">
                        </div>
                        <button id="add-journal-entry-btn" class="btn btn-primary w-full mb-4">New Log Entry</button>
                        <ul id="journal-directory-list"></ul>
                    </div>
                    <div class="flex-grow p-6 overflow-y-auto">
                        <div class="entry-content prose prose-invert max-w-none" id="entry-content-main">
                            <div class="flex justify-end gap-2 mb-4">
                                <button id="entry-edit-btn" class="btn btn-secondary hidden">Edit</button>
                            </div>
                            <h2 id="journal-entry-title">Select an Entry</h2>
                            <div id="journal-entry-body"><p class="text-gray-400">Please select an entry from the directory on the left, or create a new one.</p></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('add-journal-entry-btn').addEventListener('click', () => openModal(null, {}));
            document.getElementById('entry-edit-btn').addEventListener('click', () => {
                if (appState.currentEntryId) {
                    const entry = appState.journalEntries.find(e => e.id === appState.currentEntryId);
                    if (entry) openModal(entry.id, entry);
                }
            });
            document.getElementById('search-input').addEventListener('input', renderJournalDirectory);
            loadJournalEntries();
        }

        // --- Data Handling & Local Storage ---
        function loadJournalEntries() {
            const entriesJSON = localStorage.getItem('logJournalEntries');
            appState.journalEntries = entriesJSON ? JSON.parse(entriesJSON) : [];
            renderJournalDirectory();
            if (appState.currentEntryId && appState.journalEntries.some(e => e.id === appState.currentEntryId)) {
                displayJournalEntry(appState.currentEntryId);
            } else if (appState.journalEntries.length > 0) {
                const sortedEntries = [...appState.journalEntries].sort((a, b) => b.createdAt - a.createdAt);
                if (sortedEntries.length > 0) {
                   displayJournalEntry(sortedEntries[0].id);
                }
            }
        }

        function saveJournalEntries() {
            localStorage.setItem('logJournalEntries', JSON.stringify(appState.journalEntries));
        }

        function renderJournalDirectory() {
            const container = document.getElementById('journal-directory-list');
            if (!container) return;

            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            let filteredEntries = appState.journalEntries;

            if (searchTerm) {
                filteredEntries = appState.journalEntries.filter(entry => {
                    const titleMatch = entry.title?.toLowerCase().includes(searchTerm);
                    const tagsMatch = entry.tags?.toLowerCase().includes(searchTerm);
                    const datetimeMatch = entry.datetime?.toLowerCase().includes(searchTerm);
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = entry.content || '';
                    const contentText = tempDiv.textContent || tempDiv.innerText || '';
                    const contentMatch = contentText.toLowerCase().includes(searchTerm);
                    
                    return titleMatch || tagsMatch || contentMatch || datetimeMatch;
                });
            }

            const sortedEntries = [...filteredEntries].sort((a, b) => b.createdAt - a.createdAt);

            if (sortedEntries.length === 0) {
                container.innerHTML = `<p class="text-center text-sm text-subtle">No entries found.</p>`;
                return;
            }

            container.innerHTML = sortedEntries.map(entry => `
                <li>
                    <a href="#" class="block p-2 rounded hover:bg-gray-700 ${entry.id === appState.currentEntryId ? 'bg-gray-700' : ''}" data-entry-id="${entry.id}">
                        <p class="font-bold text-sm text-light">${entry.title || 'Untitled'}</p>
                        <p class="text-xs text-subtle">${entry.datetime || 'No Date'}</p>
                    </a>
                </li>
            `).join('');
            
            container.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayJournalEntry(link.dataset.entryId);
                });
            });
        }

        function displayJournalEntry(entryId) {
            const entryTitle = document.getElementById('journal-entry-title');
            const entryBody = document.getElementById('journal-entry-body');
            const entryEditBtn = document.getElementById('entry-edit-btn');

            if(!entryTitle || !entryBody || !entryEditBtn) return;

            const entry = appState.journalEntries.find(e => e.id === entryId);
            appState.currentEntryId = entryId;

            if (entry) {
                entryTitle.textContent = entry.title || 'Untitled';
                let contentHtml = `<p class="text-sm text-subtle"><strong>Logged:</strong> ${entry.datetime || 'N/A'} | <strong>Tags:</strong> ${entry.tags || 'None'}</p>`;
                contentHtml += parseEntryLinks(entry.content || '<p class="text-gray-400">No content for this entry.</p>');
                
                entryBody.innerHTML = contentHtml;
                entryEditBtn.classList.remove('hidden');
            } else {
                entryTitle.textContent = 'Entry Not Found';
                entryBody.innerHTML = '<p class="text-red-400">The requested entry could not be found.</p>';
                entryEditBtn.classList.add('hidden');
                appState.currentEntryId = null;
            }
            renderJournalDirectory(); // Re-render to highlight the active entry
        }

        // --- Modal & Form Logic ---
        function createFormFieldHtml(fieldKey, fieldConfig, savedValue) {
            const labelText = (fieldConfig.label || fieldKey.replace(/_/g, ' ')).toUpperCase();
            let fieldHtml = '';

            switch (fieldConfig.type) {
                case 'textarea':
                    fieldHtml = `<div id="editor-${fieldKey}" class="quill-editor-container"></div><input type="hidden" id="${fieldKey}" name="${fieldKey}">`;
                    break;
                case 'text':
                    fieldHtml = `<input type="text" id="${fieldKey}" name="${fieldKey}" value="${savedValue || ''}" class="global-form-input">`;
                    break;
            }

            return `<div><label for="${fieldKey}" class="global-form-label">${labelText}</label>${fieldHtml}</div>`;
        }

        function openModal(entryId = null, data = {}) {
            appState.editingEntryId = entryId;
            modalTitle.textContent = entryId ? 'Edit Log Entry' : 'Create New Log Entry';
            
            const formHtml = Object.keys(entryConfig.fields).map(key => {
                const config = entryConfig.fields[key];
                return createFormFieldHtml(key, config, data[key]);
            }).join('');
            formFieldsContainer.innerHTML = formHtml;

            // Initialize Quill editor for the 'content' field
            const editorContainer = formFieldsContainer.querySelector('#editor-content');
            if (editorContainer) {
                const hiddenInput = document.getElementById('content');
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote', 'code-block'],
                    ['link'],
                    ['clean']
                ];
                const quill = new Quill(editorContainer, {
                    modules: { toolbar: toolbarOptions },
                    theme: 'snow',
                    placeholder: 'Start writing your log entry...'
                });
                quill.root.innerHTML = data.content || '';
                hiddenInput.value = data.content || '';
                quill.on('text-change', () => { hiddenInput.value = quill.root.innerHTML; });
            }
            
            modalDeleteBtn.classList.toggle('hidden', !entryId);
            entryModal.classList.remove('hidden');
        }

        function closeModal() {
            appState.editingEntryId = null;
            entryForm.reset();
            entryModal.classList.add('hidden');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(entryForm);
            const data = Object.fromEntries(formData.entries());
            
            if (appState.editingEntryId) {
                // Update existing entry
                const index = appState.journalEntries.findIndex(e => e.id === appState.editingEntryId);
                if (index !== -1) {
                    appState.journalEntries[index] = { ...appState.journalEntries[index], ...data };
                }
            } else {
                // Create new entry
                data.id = `entry_${Date.now()}`;
                data.createdAt = Date.now(); // For reliable sorting
                data.datetime = new Date().toLocaleString([], { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                appState.journalEntries.push(data);
                appState.currentEntryId = data.id;
            }
            
            saveJournalEntries();
            loadJournalEntries();
            displayJournalEntry(appState.currentEntryId);
            closeModal();
        }

        function deleteCurrentEntry() {
            if (!appState.editingEntryId) return;

            showConfirmModal('Are you sure you want to delete this log entry?', () => {
                appState.journalEntries = appState.journalEntries.filter(e => e.id !== appState.editingEntryId);
                saveJournalEntries();
                
                // Clear view if it was the deleted entry
                if (appState.currentEntryId === appState.editingEntryId) {
                    appState.currentEntryId = null;
                    document.getElementById('journal-entry-title').textContent = 'Select an Entry';
                    document.getElementById('journal-entry-body').innerHTML = '<p>Please select an entry.</p>';
                    document.getElementById('entry-edit-btn').classList.add('hidden');
                }
                
                closeModal();
                loadJournalEntries();
            });
        }

        // --- Utility Functions ---
        function parseEntryLinks(text) {
            if (!text) return '';
            // This is a placeholder for potential future linking functionality.
            // For now, it just returns the text.
            return text;
        }

        function showError(message) {
            errorMessage.textContent = message.toUpperCase();
            errorModal.classList.remove('hidden');
        }
        function hideErrorModal() { errorModal.classList.add('hidden'); }
        
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message.toUpperCase();
            appState.confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        function hideConfirmModal() {
            appState.confirmCallback = null;
            confirmModal.classList.add('hidden');
        }

        // --- Global Event Listeners ---
        entryForm.addEventListener('submit', handleFormSubmit);
        modalCancelBtn.addEventListener('click', closeModal);
        modalDeleteBtn.addEventListener('click', deleteCurrentEntry);
        document.getElementById('modal-explicit-close-btn').addEventListener('click', closeModal);
        
        confirmOkBtn.addEventListener('click', () => {
            if (appState.confirmCallback) appState.confirmCallback();
            hideConfirmModal();
        });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        errorOkBtn.addEventListener('click', hideErrorModal);

        window.addEventListener('click', (event) => {
            if (event.target == confirmModal) hideConfirmModal();
            if (event.target == errorModal) hideErrorModal();
            if (event.target == entryModal) closeModal();
        });

        // --- Initial Load ---
        renderJournalView();

    </script>
</body>
</html>
