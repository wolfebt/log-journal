<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aime Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* --- Global Theme --- */
        :root {
            --bg-main: #212121;
            --bg-section: #333333;
            --bg-header: #1f2937;
            --bg-input: #424242;
            --bg-input-focus: #616161;
            --bg-hover: #4f4f4f;
            --bg-danger: #b71c1c;
            --bg-danger-hover: #d32f2f;
            
            --text-light: #f5f5f5;
            --text-dark: #212121;
            --text-subtle: #9e9e9e;
            
            --border-main: #9e9e9e;
            --border-subtle: #616161;
            --border-focus: #f5f5f5;

            --btn-primary-bg: #4f4f4f;
            --btn-primary-border: #9e9e9e;
            --btn-primary-hover-bg: #616161;
            --btn-primary-hover-border: #f5f5f5;
            
            --font-body: 'Trebuchet MS', sans-serif;
            --font-display: 'Trebuchet MS', sans-serif;

            --header-height: 4rem; 
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--bg-section); }
        ::-webkit-scrollbar-thumb { background-color: var(--bg-input-focus); border-radius: 6px; border: 3px solid var(--bg-section); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--border-main); }

        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-main); color: var(--text-light); font-family: var(--font-body); display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }

        /* --- Layout --- */
         .app-header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 40; background-color: var(--bg-header); border-bottom: 2px solid var(--border-subtle); padding: 0.5rem 1rem; }
        .app-container { display: flex; flex-grow: 1; padding-top: var(--header-height); }
        main#main-content { flex-grow: 1; padding: 0; overflow-y: auto; }

        /* --- Global Components --- */
        .app-header h1 { font-family: var(--font-display); }
        .modal-backdrop { background-color: rgba(0,0,0,0.75); }
        .modal-content { background-color: var(--bg-section); border: 2px solid var(--border-main); }
        .modal-content h2, .modal-content h3 { font-family: var(--font-display); text-transform: uppercase; }
        .global-form-label { color: var(--text-subtle); text-transform: uppercase; font-size: 0.8rem; margin-bottom: 0.25rem; display: block; }
        .global-form-input { background-color: var(--bg-input); border: 1px solid var(--border-main); color: var(--text-light); width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.25rem; transition: all 0.2s ease; }
        .global-form-input:focus { outline: none; border-color: var(--border-focus); background-color: var(--bg-input-focus); }
        
        #modal-x-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-subtle);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
            z-index: 60;
        }
        #modal-x-close-btn:hover { color: var(--text-light); }

        /* --- File Menu for Modal --- */
        .file-menu { position: relative; display: inline-block; }
        .file-menu-button { background-color: var(--bg-section); border: 2px solid var(--border-main); transition: all 0.2s ease; font-weight: bold; padding: 0.5rem 1rem; border-radius: 5px; }
        .file-menu-button:hover { border-color: var(--border-focus); background-color: var(--bg-hover); }
        .file-menu-dropdown { display: none; position: absolute; left: 0; background-color: var(--bg-section); min-width: 160px; border: 2px solid var(--border-main); box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 101; border-radius: 5px; padding: 0.5rem 0; }
        .file-menu-dropdown.show { display: block; }
        .file-menu-dropdown button { color: var(--text-light); padding: 0.75rem 1rem; text-decoration: none; display: block; width: 100%; text-align: left; background: none; border: none; cursor: pointer; }
        .file-menu-dropdown button:hover { background-color: var(--bg-hover); }
        
        .btn { font-family: var(--font-body); font-weight: bold; padding: 0.75rem 1rem; border: 2px solid; border-radius: 5px; cursor: pointer; transition: all 0.2s ease-in-out; text-shadow: 1px 1px 2px #000; }
        .btn:hover:not(:disabled) { text-shadow: none; }
        .btn:disabled { background-color: var(--bg-input); border-color: var(--border-subtle); color: var(--text-subtle); cursor: not-allowed; text-shadow: none; }
        
        .btn-primary { background-color: var(--btn-primary-bg); border-color: var(--btn-primary-border); color: var(--text-light); text-transform: uppercase; }
        .btn-primary:hover:not(:disabled) { background-color: var(--btn-primary-hover-bg); border-color: var(--btn-primary-hover-border); }
        .btn-danger { background-color: var(--bg-danger); border-color: var(--btn-danger-border); color: var(--text-light); text-transform: uppercase; }
        .btn-danger:hover:not(:disabled) { background-color: var(--bg-danger-hover); border-color: var(--btn-danger-hover-border); }
        .btn-secondary { background-color: var(--bg-section); border-color: var(--text-subtle); color: var(--text-light); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-hover); border-color: var(--border-focus); }
        
        /* Quill Dark Theme Overrides */
        .ql-toolbar { background-color: var(--bg-header); border: 1px solid var(--border-main) !important; border-bottom: none !important; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem; }
        .ql-container.ql-snow { border: 1px solid var(--border-main) !important; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem; background-color: var(--bg-input); color: var(--text-light); font-family: var(--font-body); }
        .ql-editor { min-height: 250px; }
        .ql-editor.ql-blank::before { color: var(--text-subtle); font-style: normal; }
        .ql-snow .ql-stroke { stroke: var(--text-subtle); }
        .ql-snow .ql-fill, .ql-snow .ql-stroke.ql-fill { fill: var(--text-subtle); }
        .ql-snow.ql-toolbar button:hover .ql-stroke, .ql-snow .ql-toolbar button.ql-active .ql-stroke { stroke: var(--text-light); }
        .ql-snow.ql-toolbar button:hover .ql-fill, .ql-snow .ql-toolbar button.ql-active .ql-fill { fill: var(--text-light); }
        .ql-snow .ql-picker-options { background-color: var(--bg-section); border-color: var(--border-main) !important; }
        .ql-snow .ql-tooltip { background-color: var(--bg-section); border: 1px solid var(--border-main); box-shadow: none; color: var(--text-light); }
        
        /* Prose styles for rendered Quill content */
        .prose { color: var(--text-light); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--text-light); }
        .prose a { color: #63b3ed; }

        /* AI Toolbar Styles */
        .ai-toolbar {
            position: absolute;
            z-index: 100;
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            border: 1px solid #4b5563; /* gray-600 */
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            transform: translate(-50%, -100%);
            margin-bottom: 0.5rem; /* Space from selected text */
            width: 420px;
        }
        .ai-toolbar button, .ai-toolbar .ai-dropdown > button {
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #d1d5db; /* gray-300 */
            background-color: transparent;
            border: none;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
        }
        .ai-toolbar button:hover, .ai-toolbar .ai-dropdown > button:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .ai-toolbar .ai-dropdown {
            position: relative;
        }
        .ai-toolbar .ai-dropdown-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            margin-bottom: 0.5rem;
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 110;
            min-width: 160px;
        }
        .ai-toolbar .ai-dropdown:hover .ai-dropdown-menu {
            display: block;
        }
        .ai-toolbar .ai-dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
        }

        /* AI Tools Container in Modal */
        #ai-tools-container {
            background-color: var(--bg-header);
            border: 1px solid var(--border-main);
            border-top: none;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        #ai-tools-container .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            text-transform: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Listening State Styling (for Dictate and Read Aloud) */
        #ai-dictate-btn.listening, #ai-read-aloud-btn.listening {
            background-color: var(--bg-danger);
            border-color: var(--btn-danger-hover-border);
        }
        #ai-dictate-btn.listening {
             animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
          0%, 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
          50% { box-shadow: 0 0 0 8px rgba(211, 47, 47, 0); }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header flex justify-between items-center px-4">
        <div>
            <button id="settings-btn" title="Settings" class="btn btn-secondary p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>
        <div class="text-center">
            <h1 class="text-xl font-bold text-gray-100 whitespace-nowrap">AIME JOURNAL</h1>
            <p class="text-xs text-gray-400 uppercase">AI-Enhanced Digital Log</p>
        </div>
        <div class="w-16 flex justify-end">
             <button id="sign-out-btn" title="Sign Out" class="btn btn-secondary hidden p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
             </button>
        </div>
    </header>
    
    <!-- Login Container -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-gray-800 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold text-gray-100 mb-2">Aime Journal</h1>
            <p class="text-gray-400 mb-6">Sign in to continue</p>
            <button id="google-signin-btn" class="btn btn-primary flex items-center justify-center w-full max-w-xs mx-auto">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App Container (initially hidden) -->
    <div class="app-container hidden">
        <main id="main-content"></main>
    </div>

    <!-- Main Entry Modal -->
    <div id="entry-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-3/4 max-w-6xl max-h-[90vh] overflow-y-auto flex flex-col relative">
            <button id="modal-x-close-btn">&times;</button>
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="file-menu"><button id="modal-data-btn" class="file-menu-button">DATA</button><div id="modal-data-dropdown" class="file-menu-dropdown"></div></div>
                    <h2 id="modal-title" class="text-2xl font-bold">Manage Entry</h2>
                    <div class="w-24"></div> <!-- Spacer -->
                </div>
                <form id="entry-form">
                    <div id="form-fields" class="space-y-6"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODALS (Delete, Unsaved, Error, Settings, Brainstorm) -->
    <div id="delete-confirm-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop"><div class="modal-content w-full max-w-lg p-8"><h2 class="text-xl font-bold mb-4">Confirm Deletion</h2><p id="delete-confirm-message" class="text-gray-400 mb-4">This action is permanent. To confirm, please type the full title of the entry: <strong id="delete-confirm-title" class="text-light"></strong></p><input type="text" id="delete-confirm-input" class="global-form-input mb-6" placeholder="Type title to confirm..."><div class="flex justify-end gap-2"><button id="delete-confirm-cancel-btn" class="btn btn-secondary">CANCEL</button><button id="delete-confirm-ok-btn" class="btn btn-danger" disabled>DELETE</button></div></div></div>
    <div id="unsaved-changes-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop"><div class="modal-content w-full max-w-lg p-8"><h2 class="text-xl font-bold mb-4">Unsaved Changes</h2><p class="text-gray-400 mb-6">You have unsaved changes. Are you sure you want to continue?</p><div class="flex justify-end gap-3"><button id="unsaved-cancel-btn" class="btn btn-secondary">CANCEL</button><button id="unsaved-discard-btn" class="btn btn-danger">DISCARD</button><button id="unsaved-save-btn" class="btn btn-primary">SAVE & CLOSE</button></div></div></div>
    <div id="error-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-[100] p-4 hidden modal-backdrop"><div class="modal-content w-full max-w-md p-8"><h2 class="text-xl font-bold mb-4 text-red-500">Error</h2><p id="error-message" class="text-gray-400 mb-6">Something went wrong.</p><div class="flex justify-end"><button id="error-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="settings-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop"><div class="modal-content w-full max-w-md p-8"><h2 class="text-xl font-bold mb-4">Settings</h2><p class="text-gray-400 mb-4">Enter your Gemini API Key. Your key is saved locally in your browser and is never shared.</p><p class="text-sm text-yellow-400 mb-4"><strong>Warning:</strong> For your security, do not use this application on a public or shared computer. For a production application, this key should be handled by a secure backend.</p><div><label for="api-key-input" class="global-form-label">Gemini API Key</label><input type="password" id="api-key-input" class="global-form-input" placeholder="Enter your API key here"></div><div class="mt-6 flex justify-end gap-4"><button id="settings-cancel-btn" class="btn btn-secondary">Cancel</button><button id="settings-save-btn" class="btn btn-primary">Save Key</button></div></div></div>
    <div id="brainstorm-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop"><div class="modal-content w-full max-w-lg p-8"><h3 class="text-2xl font-bold text-gray-100 mb-4">Brainstormed Ideas ✨</h3><ul id="brainstorm-list" class="space-y-3 list-disc list-inside text-gray-300"></ul><button id="brainstorm-close-btn" class="mt-6 w-full btn btn-primary">Close</button></div></div>

    <!-- AI Floating Toolbar (Initially Hidden) -->
    <div id="ai-toolbar" class="ai-toolbar hidden"></div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
          apiKey: "AIzaSyDIOV7lbfI5YsN_2LG_dSg-xNMSEqz2PM0",
          authDomain: "log-journal-95f36.firebaseapp.com",
          projectId: "log-journal-95f36",
          storageBucket: "log-journal-95f36.appspot.com",
          messagingSenderId: "756913638787",
          appId: "1:756913638787:web:7f005c9406b09468e1bab6",
          measurementId: "G-WPBTFBQ5SS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- Application Configuration ---
        const entryConfig = { label: 'Journal Entry', fields: { title: { type: 'text', required: true }, tags: { type: 'text', label: 'Tags (comma-separated)' }, content: { type: 'textarea' }, } };

        // --- Application State ---
        const appState = { userId: null, authReady: false, editingEntryId: null, journalEntries: [], currentEntryId: null, initialFormState: null, unsubscribe: null, apiKey: null, isAiLoading: false, quillInstance: null, selectionRange: null, recognition: null, ttsAudio: null };
        
        // --- UI Element References ---
        const loginContainer = document.getElementById('login-container');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const appContainer = document.querySelector('.app-container');
        const mainContentContainer = document.getElementById('main-content');
        const entryModal = document.getElementById('entry-modal');
        const modalTitle = document.getElementById('modal-title');
        const entryForm = document.getElementById('entry-form');
        const formFieldsContainer = document.getElementById('form-fields');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const unsavedChangesModal = document.getElementById('unsaved-changes-modal');
        const errorModal = document.getElementById('error-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const brainstormModal = document.getElementById('brainstorm-modal');
        const aiToolbar = document.getElementById('ai-toolbar');

        // --- Audio Processing Helper Functions ---
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };
        const pcmToWav = (pcmData, sampleRate) => {
            const pcm16 = new Int16Array(pcmData);
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }};
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            return new Blob([view, pcm16], { type: 'audio/wav' });
        };
        
        // --- AI Service Object ---
        const AIService = {
          textApiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`,
          ttsApiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent`,
          async _fetchWithTimeout(url, options, timeout = 20000) { const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), timeout); try { const response = await fetch(url, { ...options, signal: controller.signal }); if (!response.ok) { const errorBody = await response.text(); console.error("API Error Response:", errorBody); throw new Error(`API request failed: ${response.statusText}`); } return response; } catch (error) { if (error.name === 'AbortError') { throw new Error("The AI request timed out."); } throw error; } finally { clearTimeout(timeoutId); } },
          async generateText(prompt, apiKey, jsonSchema = null) { if (!apiKey) return Promise.reject(new Error("API Key is not configured. Go to Settings to add it.")); const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7, topK: 1, topP: 1, maxOutputTokens: 1024 }, }; if (jsonSchema) { payload.generationConfig.responseMimeType = "application/json"; payload.generationConfig.responseSchema = jsonSchema; } const response = await this._fetchWithTimeout(`${this.textApiUrl}?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), }); const result = await response.json(); const content = result.candidates?.[0]?.content?.parts?.[0]?.text; if (!content) { throw new Error("Received an invalid response from the AI."); } return content; },
          async speak(text, apiKey) { if (!apiKey) return Promise.reject(new Error("API Key is not configured.")); const payload = { model: "gemini-2.5-flash-preview-tts", contents: [{ parts: [{ text: `Say this clearly: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"] }, }; const response = await this._fetchWithTimeout(`${this.ttsApiUrl}?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), }); const result = await response.json(); const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data; if (!audioData) { throw new Error("Failed to generate audio."); } return audioData; },
          _getPromptForAction(action) { 
            const { type, text, payload } = action; 
            switch (type) { 
              case 'fixGrammar': return `Correct any spelling mistakes, fix grammatical errors, and improve the phrasing of the following text without changing its meaning. Return only the corrected text.\n\nText: "${text}"`; 
              case 'summarize': return `Summarize the following text ${payload.format}. Return only the summarized text.\n\nText: "${text}"`; 
              case 'rephrase': let rephraseInstruction = payload.style === 'simplify' ? 'using simpler language' : 'to be more eloquent and professional'; return `Rephrase the following text ${rephraseInstruction}. Maintain the core message. Return only the rephrased text.\n\nText: "${text}"`; 
              case 'translate': return `Translate the following text into ${payload.language}. Return only the translated text.\n\nText: "${text}"`; 
              case 'formatAs': return `You are a creative writer. Reformat the following text as ${payload.format}. Return only the reformatted text, using appropriate markdown if necessary.\n\nText: "${text}"`;
              case 'changePerspective': return `You are a skilled writer. Rewrite the following text from a ${payload.perspective} perspective. Adjust the pronouns and narrative style accordingly, but maintain the core message. Return only the rewritten text.\n\nText: "${text}"`;
              case 'custom': return `Apply the following instruction to the provided text. Return only the modified text. Instruction: "${payload.instruction}"\n\nText: "${text}"`; 
              default: throw new Error('Invalid transformation type.'); 
            } 
          },
          transformText(action, apiKey) { const prompt = this._getPromptForAction(action); return this.generateText(prompt, apiKey); },
          continueWriting(text, apiKey) { const prompt = `You are a helpful writing assistant. Continue writing the following text, adding one or two new paragraphs that logically follow. Do not repeat the original text in your response. Begin the continuation directly.\n\nText: "${text}"`; return this.generateText(prompt, apiKey); },
          brainstormIdeas(text, apiKey) { const prompt = `You are a creative strategist. Brainstorm a list of 5 ideas based on the following text. The ideas should be concise and actionable.\n\nText: "${text}"`; const schema = { type: "ARRAY", items: { type: "STRING" } }; return this.generateText(prompt, apiKey, schema).then(JSON.parse); }
        };

        // --- View Rendering ---
        function renderJournalView() {
            mainContentContainer.innerHTML = `<div class="flex" style="height: calc(100vh - var(--header-height));"><div id="journal-directory-main" class="w-80 flex-shrink-0 bg-gray-800 p-4 overflow-y-auto border-r-2 border-gray-700"><div class="mb-4"><input type="search" id="search-input" placeholder="Search entries..." class="global-form-input"></div><button id="add-journal-entry-btn" class="btn btn-primary w-full mb-4">New Log Entry</button><ul id="journal-directory-list"></ul></div><div class="flex-grow p-6 overflow-y-auto"><div class="entry-content prose prose-invert max-w-none" id="entry-content-main"><h2 id="journal-entry-title">Select an Entry</h2><div id="journal-entry-body"><p class="text-gray-400">Please select an entry from the directory on the left, or create a new one.</p></div></div></div></div>`;
            document.getElementById('add-journal-entry-btn').addEventListener('click', () => openModal(null, {}));
            document.getElementById('search-input').addEventListener('input', renderJournalDirectory);
        }

        function listenForJournalEntries() {
            if (appState.unsubscribe) appState.unsubscribe(); // Detach old listener if exists
            if (!appState.userId) return;

            const entriesCollection = collection(db, 'artifacts', appId, 'users', appState.userId, 'entries');
            appState.unsubscribe = onSnapshot(entriesCollection, (snapshot) => {
                appState.journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                appState.journalEntries.forEach(entry => {
                    if (entry.createdAt && entry.createdAt.toDate) {
                        entry.datetime = entry.createdAt.toDate().toLocaleString([], { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                });

                renderJournalDirectory();

                if (appState.currentEntryId && appState.journalEntries.some(e => e.id === appState.currentEntryId)) {
                   // Entry is already displayed, no need to re-render it here.
                } else if (appState.journalEntries.length > 0) {
                    const sortedEntries = [...appState.journalEntries].sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    if (sortedEntries.length > 0) {
                       displayJournalEntry(sortedEntries[0].id);
                    }
                } else {
                    const entryTitle = document.getElementById('journal-entry-title');
                    const entryBody = document.getElementById('journal-entry-body');
                    if(entryTitle) entryTitle.textContent = 'Welcome!';
                    if(entryBody) entryBody.innerHTML = '<p class="text-gray-400">Create your first log entry to get started.</p>';
                }
            }, (error) => {
                showError("Could not connect to the database. Please check your connection and refresh.");
                console.error("Firestore listener error:", error);
            });
        }

        function renderJournalDirectory() {
            const container = document.getElementById('journal-directory-list');
            if (!container) return;
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filteredEntries = searchTerm
                ? appState.journalEntries.filter(entry => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = entry.content || '';
                    const contentText = tempDiv.textContent || tempDiv.innerText || '';
                    return (entry.title?.toLowerCase().includes(searchTerm) ||
                            entry.tags?.toLowerCase().includes(searchTerm) ||
                            entry.datetime?.toLowerCase().includes(searchTerm) ||
                            contentText.toLowerCase().includes(searchTerm));
                })
                : appState.journalEntries;

            const sortedEntries = [...filteredEntries].sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            if (sortedEntries.length === 0) {
                container.innerHTML = `<p class="text-center text-sm text-subtle">No entries found.</p>`;
                return;
            }

            container.innerHTML = sortedEntries.map(entry => `
                <li>
                    <a href="#" class="block p-2 rounded hover:bg-gray-700 ${entry.id === appState.currentEntryId ? 'bg-gray-700' : ''}" data-entry-id="${entry.id}">
                        <p class="font-bold text-sm text-light">${entry.title || 'Untitled'}</p>
                        <p class="text-xs text-subtle">${entry.datetime || 'No Date'}</p>
                    </a>
                </li>
            `).join('');
            
            container.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); displayJournalEntry(link.dataset.entryId); });
                link.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    const entry = appState.journalEntries.find(e => e.id === link.dataset.entryId);
                    if (entry) openModal(entry.id, entry);
                });
            });
        }

        function displayJournalEntry(entryId) {
            const entryTitle = document.getElementById('journal-entry-title');
            const entryBody = document.getElementById('journal-entry-body');
            if(!entryTitle || !entryBody) return;

            const entry = appState.journalEntries.find(e => e.id === entryId);
            appState.currentEntryId = entryId;

            if (entry) {
                entryTitle.textContent = entry.title || 'Untitled';
                let contentHtml = `<p class="text-sm text-subtle"><strong>Logged:</strong> ${entry.datetime || 'N/A'} | <strong>Tags:</strong> ${entry.tags || 'None'}</p>`;
                contentHtml += (entry.content || '<p class="text-gray-400">No content for this entry.</p>');
                entryBody.innerHTML = contentHtml;
            } else {
                entryTitle.textContent = 'Entry Not Found';
                entryBody.innerHTML = '<p class="text-red-400">The requested entry could not be found.</p>';
                appState.currentEntryId = null;
            }
            renderJournalDirectory();
        }
        
        // --- Modal & Form Logic (with AI integrations) ---
        function getFormState() { if (!entryForm) return null; const formData = new FormData(entryForm); const data = Object.fromEntries(formData.entries()); return JSON.stringify(data); }
        function isFormDirty() { if (entryModal.classList.contains('hidden')) return false; return appState.initialFormState !== getFormState(); }
        function attemptToCloseModal() { if (isFormDirty()) { unsavedChangesModal.classList.remove('hidden'); } else { closeModal(); } }

        function createFormFieldHtml(fieldKey, fieldConfig, savedValue) {
            const labelText = (fieldConfig.label || fieldKey.replace(/_/g, ' ')).toUpperCase();
            if (fieldConfig.type === 'textarea') {
                return `<div>
                    <label for="${fieldKey}" class="global-form-label">${labelText}</label>
                    <div id="editor-container">
                        <div id="editor-${fieldKey}"></div>
                        <div id="ai-tools-container">
                            <span class="text-sm font-semibold text-gray-400 mr-2">✨ AI Tools</span>
                            <button type="button" id="ai-continue-btn" class="btn btn-secondary">Continue Writing</button>
                            <button type="button" id="ai-brainstorm-btn" class="btn btn-secondary">Brainstorm Ideas</button>
                            <button type="button" id="ai-read-aloud-btn" class="btn btn-secondary">Read Aloud</button>
                            <button type="button" id="ai-dictate-btn" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/></svg>
                                <span id="dictate-btn-text">Dictate</span>
                            </button>
                            <div id="ai-loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-gray-100"></div>
                        </div>
                    </div>
                    <input type="hidden" id="${fieldKey}" name="${fieldKey}">
                </div>`;
            } else {
                 return `<div><label for="${fieldKey}" class="global-form-label">${labelText}</label><input type="text" id="${fieldKey}" name="${fieldKey}" value="${savedValue || ''}" class="global-form-input"></div>`;
            }
        }

        function openModal(entryId = null, data = {}) {
            appState.editingEntryId = entryId;
            modalTitle.textContent = entryId ? 'Edit Log Entry' : 'Create New Log Entry';
            formFieldsContainer.innerHTML = Object.keys(entryConfig.fields).map(key => createFormFieldHtml(key, entryConfig.fields[key], data[key])).join('');
            const editorContainer = formFieldsContainer.querySelector('#editor-content');
            if (editorContainer) {
                const hiddenInput = document.getElementById('content');
                appState.quillInstance = new Quill(editorContainer, {
                    modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['blockquote', 'code-block'], ['link'], ['clean']] },
                    theme: 'snow', placeholder: 'Start writing your log entry...'
                });
                appState.quillInstance.root.innerHTML = data.content || '';
                hiddenInput.value = data.content || '';
                appState.quillInstance.on('text-change', () => { hiddenInput.value = appState.quillInstance.root.innerHTML; });
                editorContainer.addEventListener('mouseup', handleEditorMouseUp);
                editorContainer.addEventListener('keyup', handleEditorMouseUp);
                document.getElementById('ai-continue-btn').addEventListener('click', handleContinueWriting);
                document.getElementById('ai-brainstorm-btn').addEventListener('click', handleBrainstorm);
                document.getElementById('ai-read-aloud-btn').addEventListener('click', handleReadAloud);
                const dictateBtn = document.getElementById('ai-dictate-btn');
                if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                    dictateBtn.addEventListener('click', handleDictation);
                } else {
                    dictateBtn.disabled = true;
                    dictateBtn.title = "Speech recognition not supported in this browser.";
                }

                // Conditionally show AI tools based on API key presence
                const aiToolsContainer = document.getElementById('ai-tools-container');
                if (aiToolsContainer) {
                    aiToolsContainer.style.display = appState.apiKey ? 'flex' : 'none';
                }
            }
            const modalDataDropdown = document.getElementById('modal-data-dropdown');
            modalDataDropdown.innerHTML = `<button id="modal-save-btn">Save</button>${entryId ? `<button id="modal-delete-btn" class="text-red-400 hover:!bg-red-800">Delete</button>` : ''}<button id="modal-close-btn">Close</button>`;
            document.getElementById('modal-save-btn').addEventListener('click', () => entryForm.requestSubmit());
            document.getElementById('modal-close-btn').addEventListener('click', attemptToCloseModal);
            if (entryId) { document.getElementById('modal-delete-btn').addEventListener('click', showDeleteConfirmation); }
            entryModal.classList.remove('hidden');
            setTimeout(() => { appState.initialFormState = getFormState(); }, 0);
        }

        function closeModal() {
            if(appState.recognition) { appState.recognition.stop(); }
            stopReadAloud(); // Stop any playing audio
            appState.editingEntryId = null; appState.initialFormState = null; appState.quillInstance = null; appState.selectionRange = null; appState.recognition = null;
            hideAiToolbar(); entryForm.reset(); entryModal.classList.add('hidden');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!appState.userId) return showError("You must be signed in to save entries.");
            const formData = new FormData(entryForm);
            const data = Object.fromEntries(formData.entries());
            const entriesCollection = collection(db, 'artifacts', appId, 'users', appState.userId, 'entries');
            try {
                if (appState.editingEntryId) {
                    await updateDoc(doc(db, entriesCollection.path, appState.editingEntryId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    const newDocRef = await addDoc(entriesCollection, data);
                    appState.currentEntryId = newDocRef.id;
                }
                closeModal();
            } catch (error) { showError("Failed to save entry. Please try again."); console.error("Firestore save error:", error); }
        }

        function showDeleteConfirmation() {
            const entry = appState.journalEntries.find(e => e.id === appState.editingEntryId);
            if (!entry) return;
            document.getElementById('delete-confirm-title').textContent = entry.title;
            const deleteInput = document.getElementById('delete-confirm-input');
            const deleteBtn = document.getElementById('delete-confirm-ok-btn');
            deleteInput.value = ''; deleteBtn.disabled = true;
            deleteConfirmModal.classList.remove('hidden');
            deleteInput.oninput = () => { deleteBtn.disabled = deleteInput.value !== entry.title; };
        }
        async function deleteCurrentEntry() {
            if (!appState.editingEntryId || !appState.userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', appState.userId, 'entries', appState.editingEntryId);
            try {
                await deleteDoc(docRef);
                if (appState.currentEntryId === appState.editingEntryId) {
                    appState.currentEntryId = null;
                    document.getElementById('journal-entry-title').textContent = 'Select an Entry';
                    document.getElementById('journal-entry-body').innerHTML = '<p>Please select an entry.</p>';
                }
                closeModal();
                deleteConfirmModal.classList.add('hidden');
            } catch(error) { showError("Failed to delete entry."); console.error("Firestore delete error:", error); }
        }
        
        // --- AI Feature Handlers ---
        function setAiLoading(isLoading, source = "") {
            appState.isAiLoading = isLoading;
            const spinner = document.getElementById('ai-loading-spinner');
            const continueBtn = document.getElementById('ai-continue-btn');
            const brainstormBtn = document.getElementById('ai-brainstorm-btn');
            const readAloudBtn = document.getElementById('ai-read-aloud-btn');
            const dictateBtn = document.getElementById('ai-dictate-btn');
        
            if (spinner) spinner.classList.toggle('hidden', !isLoading);
            
            // General case: disable all AI buttons when a task is running
            if (continueBtn) continueBtn.disabled = isLoading;
            if (brainstormBtn) brainstormBtn.disabled = isLoading;
            if (readAloudBtn) readAloudBtn.disabled = isLoading;
            if (dictateBtn) dictateBtn.disabled = isLoading;

            // Exception for Read Aloud: keep it enabled so it can be stopped
            if (appState.ttsAudio && readAloudBtn) {
                readAloudBtn.disabled = false;
            }
            // Exception for dictation: keep it enabled to be stopped
             if (appState.recognition && appState.recognition.isListening && dictateBtn) {
                dictateBtn.disabled = false;
            }
        }
        
        const handleEditorMouseUp = () => {
            if (!appState.apiKey || appState.isAiLoading || !appState.quillInstance) return;
            const range = appState.quillInstance.getSelection();
            if (range && range.length > 0) {
                appState.selectionRange = range;
                const selectionBounds = appState.quillInstance.getBounds(range.index, range.length);
                const editorBounds = appState.quillInstance.container.getBoundingClientRect();
                const x = editorBounds.left + window.scrollX + selectionBounds.left + (selectionBounds.width / 2);
                const y = editorBounds.top + window.scrollY + selectionBounds.top;
                showAiToolbar(x, y);
            } else {
                hideAiToolbar();
            }
        };

        function showAiToolbar(x, y) {
            aiToolbar.style.left = `${x}px`;
            aiToolbar.style.top = `${y}px`;
            aiToolbar.innerHTML = `
                <button data-action="fixGrammar">Fix Grammar</button>
                <div class="ai-dropdown">
                    <button>Summarize</button>
                    <div class="ai-dropdown-menu">
                        <button data-action="summarize" data-payload='{"format": "as key points"}'>To Key Points</button>
                        <button data-action="summarize" data-payload='{"format": "into a paragraph"}'>Into a Paragraph</button>
                    </div>
                </div>
                <div class="ai-dropdown">
                    <button>Rephrase</button>
                    <div class="ai-dropdown-menu">
                        <button data-action="rephrase" data-payload='{"style": "simplify"}'>Simplify</button>
                        <button data-action="rephrase" data-payload='{"style": "eloquent"}'>Make Eloquent</button>
                    </div>
                </div>
                <div class="ai-dropdown">
                    <button>Format As</button>
                    <div class="ai-dropdown-menu">
                        <button data-action="formatAs" data-payload='{"format": "a Narrative text"}'>Narrative</button>
                        <button data-action="formatAs" data-payload='{"format": "a Descriptive text"}'>Descriptive</button>
                        <button data-action="formatAs" data-payload='{"format": "an Expository text"}'>Expository</button>
                        <button data-action="formatAs" data-payload='{"format": "a Persuasive text"}'>Persuasive</button>
                        <button data-action="formatAs" data-payload='{"format": "a Recount"}'>Recount</button>
                        <button data-action="formatAs" data-payload='{"format": "a Report"}'>Report</button>
                        <button data-action="formatAs" data-payload='{"format": "a set of Procedure steps"}'>Procedure</button>
                    </div>
                </div>
                <div class="ai-dropdown">
                    <button>Perspective</button>
                    <div class="ai-dropdown-menu">
                        <button data-action="changePerspective" data-payload='{"perspective": "First-person"}'>First-person</button>
                        <button data-action="changePerspective" data-payload='{"perspective": "Second-person"}'>Second-person</button>
                        <button data-action="changePerspective" data-payload='{"perspective": "Third-person Omniscient"}'>Third-person Omniscient</button>
                        <button data-action="changePerspective" data-payload='{"perspective": "Third-person Limited"}'>Third-person Limited</button>
                        <button data-action="changePerspective" data-payload='{"perspective": "Third-person Objective"}'>Third-person Objective</button>
                    </div>
                </div>
                <button data-action="translate">Translate...</button>
                <button data-action="custom">Custom...</button>
            `;
            aiToolbar.classList.remove('hidden');
        }

        function hideAiToolbar() { aiToolbar.classList.add('hidden'); aiToolbar.innerHTML = ''; appState.selectionRange = null; }
        
        async function handleAIAction(action, payload) {
            if (!appState.quillInstance || !appState.selectionRange) return;
            const currentRange = appState.selectionRange;
            const selectedText = appState.quillInstance.getText(currentRange.index, currentRange.length);
            
            setAiLoading(true, "ai"); 
            hideAiToolbar();
            
            try {
                const transformedText = await AIService.transformText({ type: action, text: selectedText, payload }, appState.apiKey);
                appState.quillInstance.deleteText(currentRange.index, currentRange.length);
                appState.quillInstance.insertText(currentRange.index, transformedText, 'user');
                appState.quillInstance.setSelection(currentRange.index, transformedText.length);
            } catch (error) { 
                showError(error.message); 
                console.error("AI Action Error:", error);
            } finally { 
                setAiLoading(false, "ai"); 
            }
        }

        async function handleContinueWriting() {
            if (!appState.quillInstance) return;
            setAiLoading(true, "ai");
            try {
                const result = await AIService.continueWriting(appState.quillInstance.getText(), appState.apiKey);
                appState.quillInstance.insertText(appState.quillInstance.getLength(), '\n' + result, 'user');
            } catch (error) { showError(error.message); console.error("Continue Writing Error:", error);
            } finally { setAiLoading(false, "ai"); }
        }

        async function handleBrainstorm() {
            if (!appState.quillInstance || !appState.quillInstance.getText().trim()) return showError("Please write some content before brainstorming.");
            setAiLoading(true, "ai");
            try {
                const ideas = await AIService.brainstormIdeas(appState.quillInstance.getText(), appState.apiKey);
                document.getElementById('brainstorm-list').innerHTML = ideas.map(idea => `<li>${idea}</li>`).join('');
                brainstormModal.classList.remove('hidden');
            } catch (error) { showError(error.message); console.error("Brainstorm Error:", error);
            } finally { setAiLoading(false, "ai"); }
        }
        
        function stopReadAloud() {
            if (appState.ttsAudio) {
                appState.ttsAudio.pause();
                URL.revokeObjectURL(appState.ttsAudio.src);
                appState.ttsAudio = null;
            }
            const readAloudBtn = document.getElementById('ai-read-aloud-btn');
            if (readAloudBtn) {
                readAloudBtn.innerHTML = 'Read Aloud';
                readAloudBtn.classList.remove('listening');
            }
            setAiLoading(false);
        }

        async function handleReadAloud() {
            const readAloudBtn = document.getElementById('ai-read-aloud-btn');
            if (appState.ttsAudio) {
                stopReadAloud();
                return;
            }

            if (!appState.quillInstance) return;
            const range = appState.quillInstance.getSelection();
            const textToRead = (range && range.length > 0)
                ? appState.quillInstance.getText(range.index, range.length)
                : appState.quillInstance.getText();

            if (!textToRead.trim()) return showError("No text to read aloud.");
            
            setAiLoading(true, "ai");
            readAloudBtn.innerHTML = 'Generating...';
            try {
                const audioData = await AIService.speak(textToRead, appState.apiKey);
                const pcmBuffer = base64ToArrayBuffer(audioData);
                const wavBlob = pcmToWav(pcmBuffer, 24000); // Gemini TTS uses 24000Hz
                const audioUrl = URL.createObjectURL(wavBlob);
                appState.ttsAudio = new Audio(audioUrl);
                
                appState.ttsAudio.onended = () => {
                    stopReadAloud();
                };
                
                appState.ttsAudio.play();
                setAiLoading(false); 
                readAloudBtn.innerHTML = 'Stop Reading';
                readAloudBtn.classList.add('listening');
                readAloudBtn.disabled = false;
            } catch (error) { 
                showError(error.message); 
                console.error("Read Aloud Error:", error);
                stopReadAloud();
            }
        }

        function handleDictation() {
            const dictateBtn = document.getElementById('ai-dictate-btn');
            const dictateBtnText = document.getElementById('dictate-btn-text');

            if (appState.recognition && appState.recognition.isListening) {
                appState.recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            appState.recognition = new SpeechRecognition();
            appState.recognition.isListening = false;
            appState.recognition.continuous = true;
            appState.recognition.interimResults = true;
            let lastTranscriptIndex = 0;

            appState.recognition.onstart = () => {
                appState.recognition.isListening = true;
                dictateBtn.classList.add('listening');
                dictateBtnText.textContent = 'Stop Dictation';
                setAiLoading(true, "dictate");
            };

            appState.recognition.onend = () => {
                if (appState.recognition) {
                    appState.recognition.isListening = false;
                }
                dictateBtn.classList.remove('listening');
                dictateBtnText.textContent = 'Dictate';
                 setAiLoading(false, "dictate");
            };
            
            appState.recognition.onerror = (event) => {
                 showError(`Speech recognition error: ${event.error}`);
                 console.error("Speech Recognition Error", event);
            }

            appState.recognition.onresult = (event) => {
                if (!appState.quillInstance) return;
                const selection = appState.quillInstance.getSelection();
                const cursorPosition = selection ? selection.index + selection.length : appState.quillInstance.getLength();

                let finalTranscript = '';
                for (let i = lastTranscriptIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript.trim() + ' ';
                    }
                }

                if (finalTranscript) {
                    appState.quillInstance.insertText(cursorPosition, finalTranscript, 'user');
                    appState.quillInstance.setSelection(cursorPosition + finalTranscript.length);
                    lastTranscriptIndex = event.results.length;
                }
            };
            
            appState.recognition.start();
        }
        
        // --- Utility & Auth ---
        function showError(message) { document.getElementById('error-message').textContent = message.toUpperCase(); errorModal.classList.remove('hidden'); }
        async function handleGoogleSignIn() { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error("Google Sign-In Error:", error); showError("Could not sign in with Google. Please try again."); } }
        async function handleSignOut() { try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); showError("Error signing out."); } }
        
        onAuthStateChanged(auth, user => {
            if (user) {
                appState.userId = user.uid;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                signOutBtn.classList.remove('hidden');
                if (!appState.authReady) { appState.authReady = true; renderJournalView(); listenForJournalEntries(); }
            } else {
                appState.userId = null; appState.authReady = false;
                if(appState.unsubscribe) appState.unsubscribe();
                appState.journalEntries = []; appState.currentEntryId = null;
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                signOutBtn.classList.add('hidden');
                mainContentContainer.innerHTML = '';
            }
        });
        
        async function initializeAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { console.error("Custom token sign-in failed", e); await signInAnonymously(auth); }
            } else { await signInAnonymously(auth); }
        }

        // --- Global Event Listeners ---
        function setupEventListeners() {
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            signOutBtn.addEventListener('click', handleSignOut);
            entryForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('delete-confirm-ok-btn').addEventListener('click', deleteCurrentEntry);
            document.getElementById('delete-confirm-cancel-btn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            document.getElementById('unsaved-cancel-btn').addEventListener('click', () => unsavedChangesModal.classList.add('hidden'));
            document.getElementById('unsaved-discard-btn').addEventListener('click', () => { unsavedChangesModal.classList.add('hidden'); closeModal(); });
            document.getElementById('unsaved-save-btn').addEventListener('click', () => { entryForm.requestSubmit(); unsavedChangesModal.classList.add('hidden'); });
            document.getElementById('error-ok-btn').addEventListener('click', () => errorModal.classList.add('hidden'));
            document.getElementById('brainstorm-close-btn').addEventListener('click', () => brainstormModal.classList.add('hidden'));
            settingsBtn.addEventListener('click', () => { document.getElementById('api-key-input').value = appState.apiKey || ''; settingsModal.classList.remove('hidden'); });
            document.getElementById('settings-cancel-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));
            document.getElementById('settings-save-btn').addEventListener('click', () => {
                const newKey = document.getElementById('api-key-input').value;
                appState.apiKey = newKey;
                localStorage.setItem('geminiApiKey', newKey);
                settingsModal.classList.add('hidden');

                // Update AI tools visibility in the modal if it's open
                if (!entryModal.classList.contains('hidden')) {
                    const aiToolsContainer = document.getElementById('ai-tools-container');
                    if (aiToolsContainer) {
                        aiToolsContainer.style.display = appState.apiKey ? 'flex' : 'none';
                    }
                }
            });
             document.getElementById('modal-x-close-btn').addEventListener('click', attemptToCloseModal);

            aiToolbar.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button || !button.dataset.action) return;
                e.preventDefault(); e.stopPropagation();
                const action = button.dataset.action;
                const payload = button.dataset.payload ? JSON.parse(button.dataset.payload) : {};
                if (action === 'custom') { 
                    const instruction = prompt("Enter your custom instruction for the selected text:"); 
                    if(instruction) handleAIAction('custom', { instruction });
                } else if (action === 'translate') {
                    const language = prompt("Enter the language to translate to:");
                    if(language) handleAIAction('translate', { language });
                } else { 
                    handleAIAction(action, payload); 
                }
            });
            
            document.addEventListener('click', e => {
                if (e.target.matches('#modal-data-btn')) { document.getElementById('modal-data-dropdown').classList.toggle('show'); }
                else if (!e.target.closest('.file-menu')) { const dropdown = document.getElementById('modal-data-dropdown'); if(dropdown) dropdown.classList.remove('show'); }
                if (e.target === errorModal) errorModal.classList.add('hidden');
                if (e.target === unsavedChangesModal) unsavedChangesModal.classList.add('hidden');
                if (e.target === deleteConfirmModal) deleteConfirmModal.classList.add('hidden');
                if (e.target === settingsModal) settingsModal.classList.add('hidden');
                if (e.target === brainstormModal) brainstormModal.classList.add('hidden');
            });

            window.addEventListener('keydown', (event) => {
                if (!entryModal.classList.contains('hidden') && event.key === 'Escape') {
                    // Check if a sub-modal (like unsaved changes) is NOT open
                    if (unsavedChangesModal.classList.contains('hidden') && 
                        deleteConfirmModal.classList.contains('hidden')) {
                         attemptToCloseModal();
                    }
                }
            });

            window.addEventListener('beforeunload', (event) => { if (isFormDirty()) { event.preventDefault(); event.returnValue = 'You have unsaved changes.'; } });
        }

        // --- App Initialization ---
        const defaultApiKey = "AIzaSyCCobI9DLG787oq3Ee7VyjOuepoUsniAJg";
        appState.apiKey = localStorage.getItem('geminiApiKey') || defaultApiKey;
        if (appState.apiKey === defaultApiKey && !localStorage.getItem('geminiApiKey')) {
             localStorage.setItem('geminiApiKey', defaultApiKey);
        }
        setupEventListeners();
        initializeAuth();

    </script>
</body>
</html>

